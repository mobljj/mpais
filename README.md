# 相似模拟实验监测点自动识别系统

## 简介

本系统是一个基于 Python 和 Qt (PySide6) 开发的桌面应用程序，旨在自动化处理相似模拟实验中的图像数据，实现监测点的高精度识别、坐标提取与转换，并支持多期图像的变形分析。

该系统通过集成的图像处理算法流程，帮助用户从实验图像中快速准确地获取监测点的物理坐标，从而提高实验数据分析的效率和精度。

## 主要功能

* **图像管理：**
    * 加载单张或多张实验图像 (支持 .png, .jpg, .jpeg, .bmp, .tif格式)。
    * 图像列表显示，支持选择和右键移除。
    * 图像操作区实时显示当前选中的图像，支持缩放和平移。
* **两阶段监测点识别：**
    * **1. 模板匹配 (粗定位)：**
        * 用户可在图像上框选模板区域。
        * 可调的匹配阈值。
        * 执行模板匹配（基于 `cv2.matchTemplate` 和 `TM_CCOEFF_NORMED`）并结合自定义的非极大值抑制 (NMS) 算法，快速筛选候选区域。
        * 可视化显示匹配到的区域。
    * **2. 坐标提取 (精确定位)：**
        * 基于模板匹配找到的区域，对全图进行预处理（双边滤波、Otsu阈值分割、Canny边缘检测、形态学膨胀）。
        * 在各候选区域内查找轮廓，并根据可调的最小轮廓面积和最小圆度（或形状相似度）阈值进行筛选。
        * 利用图像矩 (`cv2.moments`) 计算有效轮廓的质心，作为监测点的像素坐标。
        * 对所有提取到的圆心坐标进行全局去重（基于欧氏距离）和排序（按网格从左上到右下）。
        * 可视化显示提取到的圆心。
* **坐标转换：**
    * 提供控制点表格，用户可输入至少3组控制点的像素坐标和对应的实际物理坐标。
    * 支持在图像上交互式点击选择控制点的像素坐标。
    * 执行仿射变换 (`cv2.getAffineTransform` 和 `cv2.transform` 或 NumPy 矩阵运算)，将提取到的监测点像素坐标批量转换为实际物理坐标。
    * 可视化显示转换后的实际坐标（在原图上标注）。
* **结果显示与管理：**
    * 为模板匹配、坐标提取、坐标转换（可视化）及多期对比图提供独立的弹出式结果显示窗口，支持交互查看。
    * 主界面实时更新各步骤的处理结果摘要（如匹配数量、提取中心数量、转换点数）。
    * 支持将最终计算得到的实际物理坐标保存为 CSV 文件。
* **多期变形分析：**
    * 加载多期图像并完成坐标转换后，系统能够自动进行点位匹配（基于空间邻近性和距离阈值）。
    * 计算监测点的高度变化量 ($\Delta Y$)。
    * 生成并显示多期对比图，包括：
        * 监测点高度随时间变化的折线图。
        * 最后一期监测点高度变化的空间分布图。
* **用户界面与体验：**
    * 采用 PySide6 构建图形用户界面，应用 `qdarkstyle` 提供暗色主题。
    * 耗时操作（如图像处理、绘图）在后台线程 (QThread, Worker) 中执行，避免界面卡顿，并提供进度条和状态栏信息更新。
    * 支持菜单栏操作（加载、保存、退出、视图调整）。
    * 提供中文字体支持 (尝试 `Microsoft YaHei` 和 `SimHei`)。
    * 包含程序图标。

## 依赖库

* **Python 3.x**
* **os, sys, io** (标准库)
* **qtpy** (PyQt5/PyQt6/PySide2/PySide6 兼容层, 本代码明确使用 `os.environ['QT_API'] = 'pyside6'`)
    * **PySide6** (Qt for Python)
* **OpenCV-Python (`cv2`)**: 用于核心图像处理算法。
* **NumPy**: 用于高效的数组运算。
* **SciPy**: 用于坐标去重时的距离计算 (`scipy.spatial.distance.cdist`)。
* **Pandas**: 用于数据处理，尤其是在多期分析和结果保存部分（虽然代码中保存CSV主要用了NumPy，但Pandas在绘图部分有使用）。
* **Matplotlib**: 用于绘制多期对比分析图表 (后端设置为 'Agg')。
* **qdarkstyle**: 用于提供暗色界面主题 (可选，但代码中包含)。

## 如何运行

1.  **安装依赖：**
    确保已安装 Python 环境，然后通过 pip 安装上述依赖库：
    ```bash
    pip install qtpy PySide6 opencv-python numpy scipy pandas matplotlib qdarkstyle
    ```
2.  **准备图标文件（可选但推荐）：**
    代码中引用了多个图标文件（如 `图标icons8-48.png`, `图标icons8-图像文件-50.png` 等）。请将这些图标文件放置在与 Python 脚本 (`相似模拟实验监测点自动识别系统.txt` 或重命名后的 `.py` 文件) 相同的目录下，或者确保 `resource_path` 函数能够正确定位它们。如果图标文件缺失，程序仍可运行，但会缺少图标显示并打印警告。
3.  **运行脚本：**
    将提供的 `相似模拟实验监测点自动识别系统.txt` 文件重命名为 `.py` 文件（例如 `main.py`），然后通过 Python 解释器运行：
    ```bash
    python main.py
    ```

## 使用流程简要说明

1.  **加载图像：** 通过“文件” -> “加载图像...” 菜单加载一张或多张实验图像。
2.  **选择图像：** 在左侧“加载的图像列表”中选择要处理的图像。
3.  **模板匹配：**
    * 点击“框选模板区域”按钮，在中间图像操作区拖拽鼠标选择一个代表性的监测点作为模板。
    * 调整“匹配阈值”。
    * 点击“执行模板匹配”按钮。匹配结果（矩形框）将显示在弹出的“模板匹配”结果窗口。
4.  **坐标提取：**
    * 模板匹配成功后，系统可能会自动触发坐标提取。也可以手动调整“膨胀 Kernel 大小”、“最小轮廓面积”、“最小相似度”等参数。
    * 点击“执行坐标提取”按钮。提取到的圆心将显示在弹出的“圆心提取”结果窗口。
5.  **坐标转换：**
    * 在左侧“3. 坐标转换”组的表格中，为至少3个控制点输入其在图像中的像素坐标和对应的实际物理坐标。
    * 像素坐标可以通过点击“点击选择像素坐标”按钮后，在图像操作区点击对应控制点来自动填充。
    * 实际坐标需要手动输入（格式如 `X,Y`）。
    * 点击“执行坐标转换 (当前期)”按钮。转换后的坐标和可视化结果会显示在弹出的“坐标转换结果”窗口。
6.  **多期分析：**
    * 对多张图像重复步骤 2-5。
    * 坐标转换完成后，系统会自动在后台更新多期对比图数据。
    * 通过“视图” -> “显示多期变化图”菜单查看结果。
7.  **保存结果：**
    * 通过“文件” -> “保存结果...” 菜单，可以将每张图像转换后的实际物理坐标保存为独立的 CSV 文件。

## 注意事项

* 程序没有内置撤销功能。如需修正参数或选择，请重新执行相应步骤。
* 图标文件的路径是通过 `resource_path` 函数解析的，在打包成可执行文件 (如使用 PyInstaller) 时会尝试从 `_MEIPASS` 临时目录加载，开发环境下则从脚本所在目录加载。
* Matplotlib 的中文字体依赖系统中安装的 `Microsoft YaHei` 或 `SimHei` 字体。
